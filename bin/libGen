#!/usr/bin/env php
<?php

require __DIR__.DIRECTORY_SEPARATOR.'../vendor/autoload.php';

error_reporting(1);

$last_book_id = isset($argv[4]) ? $argv[4] : 0;

try {
    $client = new GuzzleHttp\Client();

    if(!$last_book_id) {
        //Get last book id
        $first_strike = 0;
        $date_strike = 0;
        do {
            $url = "http://libgen.io/json.php?fields=ID&mode=last";
            $url .= "&timefirst=". date('Y-m-d', time() - 86400 * $date_strike);
            $url .= "&limit1=" . $first_strike * 1000 . "&limit2=1000";
            echo $url . "\n";
            $res = $client->request("GET", $url,['proxy'=>'socks5://127.0.0.1:9050']);
            $received_data = json_decode($res->getBody(),true);
            if (count($received_data) < 1000 && count($received_data) != 0) {
                $last_received_data_item = end($received_data);
                $last_book_id = $last_received_data_item["id"];
                break;
            }
            $first_strike++;
            if (count($received_data) == 0) {
                $date_strike++;
                $first_strike = 0;
            }
        } while (true);
    }
    //Download Books
    $save_url = [];
    $save_response = [];
    $bulk_counter = $argv[1];
    $limiter = $argv[2];
    if ($bulk_counter * $limiter > $last_book_id) {
        exit("OverflowException");
    }
    $bulk = intval($last_book_id/$limiter);
    $remain = $last_book_id % $limiter;
    if($remain > 0) {
        $bulk++;
    }
    $to = $bulk_counter * $limiter + $limiter;
    if ($bulk_counter <= $bulk) {
        $url = "http://libgen.io/json.php?fields=%2A&ids=";
        $from = $bulk_counter * $limiter;
        for ($id = $from + 1; $id <= $to; $id++) {
            $append = $id . ",";
            if ($id == $to) {
                $append = $id;
            }
            $url .= $append;
        }
        echo $url . "\n";
        $save_url[] = $url;
        $res = $client->request('GET', $url);
        $books = json_decode($res->getBody(),true);
        $save_response[] = $books;
        foreach ($books as $book_info) {
            if ($old_book = Book::whereBookId($book_info["id"])->first()) {
                if(strtotime($old_book->timeLastModified) < strtotime($book_info["timelastmodified"])) {
                    myMassAssignment($old_book, $book_info);
                    $old_book->save();
                    remove_book ($book_info['md5']);
                }
            } else {
                $new_book = new Book();
                myMassAssignment($new_book, $book_info);
                $new_book->save();
            }
        }
        $bulk_counter++;
        $to = ($bulk_counter + 1) * $limiter;
    }

    $schedule_id = $argv[3];
    $schedule = Schedule::find($schedule_id);
    if ($schedule) {
        $schedule->request_url = json_encode($save_url);
        $schedule->response = json_encode($save_response);
        $schedule->is_done = true;
        $schedule->save();
    }

} catch (Exception $e) {
    echo $e->getMessage() . '(Line:' . $e->getLine() . ')';
}

function myMassAssignment (&$new_book, $book_info) {
    $new_book->book_id = isset($book_info['id']) ? $book_info['id'] : '';
    $new_book->title = isset($book_info['title']) ? $book_info['title'] : '';
    $new_book->volumeInfo = isset($book_info['volumeInfo']) ? $book_info['volumeInfo'] : '';
    $new_book->series = isset($book_info['series']) ? $book_info['series'] : '';
    $new_book->periodical = isset($book_info['periodical']) ? $book_info['periodical'] : '';
    $new_book->author = isset($book_info['author']) ? $book_info['author'] : '';
    $new_book->year = isset($book_info['year']) ? $book_info['year'] : '';
    $new_book->publisher = isset($book_info['publisher']) ? $book_info['publisher'] : '';
    $new_book->city = isset($book_info['city']) ? $book_info['city'] : '';
    $new_book->pages = isset($book_info['pages']) ? $book_info['pages'] : '';
    $new_book->pagesInFile = isset($book_info['pagesinfile']) ? $book_info['pagesinfile'] : '';
    $new_book->language = isset($book_info['language']) ? $book_info['language'] : '';
    $new_book->topic = isset($book_info['topic']) ? $book_info['topic'] : '';
    $new_book->library = isset($book_info['library']) ? $book_info['library'] : '';
    $new_book->issue = isset($book_info['issue']) ? $book_info['issue'] : '';
    $new_book->ISSN = isset($book_info['issn']) ? $book_info['issn'] : '';
    $new_book->identifier = isset($book_info['identifier']) ? $book_info['identifier'] : '';
    $new_book->ASIN = isset($book_info['asin']) ? $book_info['asin'] : '';
    $new_book->UDC = isset($book_info['udc']) ? $book_info['udc'] : '';
    $new_book->LBC = isset($book_info['lbc']) ? $book_info['lbc'] : '';
    $new_book->DDC = isset($book_info['ddc']) ? $book_info['ddc'] : '';
    $new_book->LCC = isset($book_info['lcc']) ? $book_info['LCC'] : '';
    $new_book->doi = isset($book_info['doi']) ? $book_info['doi'] : '';
    $new_book->googleBookId = isset($book_info['googlebookid']) ? $book_info['googlebookid'] : '';
    $new_book->openLibraryID = isset($book_info['openlibraryid']) ? $book_info['openlibraryid'] : '';
    $new_book->commentary = isset($book_info['commentary']) ? $book_info['commentary'] : '';
    $new_book->DPI = isset($book_info['dpi']) ? $book_info['dpi'] : '';
    $new_book->color = isset($book_info['color']) ? $book_info['color'] : '';
    $new_book->cleaned = isset($book_info['cleaned']) ? $book_info['cleaned'] : '';
    $new_book->orientation = isset($book_info['orientation']) ? $book_info['orientation'] : '';
    $new_book->paginated = isset($book_info['paginated']) ? $book_info['paginated'] : '';
    $new_book->scanned = isset($book_info['scanned']) ? $book_info['scanned'] : '';
    $new_book->bookmarked = isset($book_info['bookmarked']) ? $book_info['bookmarked'] : '';
    $new_book->searchable = isset($book_info['searchable']) ? $book_info['searchable'] : '';
    $new_book->filesize = isset($book_info['filesize']) ? $book_info['filesize'] : '';
    $new_book->extension = isset($book_info['extension']) ? $book_info['extension'] : '';
    $new_book->MD5 = isset($book_info['md5']) ? $book_info['md5'] : '';
    $new_book->generic = isset($book_info['generic']) ? $book_info['generic'] : '';
    $new_book->filename = isset($book_info['filename']) ? $book_info['filename'] : '';
    $new_book->locator = isset($book_info['locator']) ? $book_info['locator'] : '';
    $new_book->local = isset($book_info['local']) ? $book_info['local'] : '';
    $new_book->timeAdded = isset($book_info['timeadded']) ? $book_info['timeadded'] : '';
    $new_book->timeLastModified = isset($book_info['timelastmodified']) ? $book_info['timelastmodified'] : '';
    $new_book->coverURL = isset($book_info['coverurl']) ? $book_info['coverurl'] : '';
    $new_book->tags = isset($book_info['tags']) ? $book_info['tags'] : '';
    $new_book->identifierWODash = isset($book_info['identifierwodash']) ? $book_info['identifierwodash'] : '';
}

function remove_book ($md5) {
    $filename = getFileNameFromUrl('http://libgen.io/ads.php?md5='.$md5);
    $pdf = Config::app('webDirectory').'download/' . basename($filename);
    $zip = Config::app('webDirectory').'download/' . basename($filename).'.zip';
    unlink ($pdf);
    unlink ($zip);
}

function getFileNameFromUrl ($url) {
    $filename = null;
    $headers = get_headers($url);
    foreach ($headers as $header) {
        if (strpos($header, 'Content-Disposition') !== false) {
            $filename = str_replace("\"", '', end(explode('=',$header)));
        }
    }
    return $filename;
}
